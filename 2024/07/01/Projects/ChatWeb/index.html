



<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="Hex" href="http://hexlove2.github.io/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="Hex" href="http://hexlove2.github.io/atom.xml" />
<link rel="alternate" type="application/json" title="Hex" href="http://hexlove2.github.io/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="Socket,TCP/IP,Github" />


<link rel="canonical" href="http://hexlove2.github.io/2024/07/01/Projects/ChatWeb/">



  <title>
ChatWeb Project - Projects |
Hex = Hex = Looking for freedom of mind</title>
<meta name="generator" content="Hexo 6.3.0"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">ChatWeb Project
  </h1>
  
<div class="meta">
  <span class="item" title="Created: 2024-07-02 00:00:00">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">Posted on</span>
    <time itemprop="dateCreated datePublished" datetime="2024-07-02T00:00:00+09:00">2024-07-02</time>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="Toggle navigation bar">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">Hex</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://raw.githubusercontent.com/Hexlove2/images1/main/images2/22.jpg"></li>
          <li class="item" data-background-image="https://raw.githubusercontent.com/Hexlove2/images1/main/images2/23.jpg"></li>
          <li class="item" data-background-image="https://raw.githubusercontent.com/Hexlove2/images1/main/images2/8.jpg"></li>
          <li class="item" data-background-image="https://raw.githubusercontent.com/Hexlove2/images1/main/images2/18.jpg"></li>
          <li class="item" data-background-image="https://raw.githubusercontent.com/Hexlove2/images1/main/images2/13.jpg"></li>
          <li class="item" data-background-image="https://raw.githubusercontent.com/Hexlove2/images1/main/images2/1.jpg"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">Home</a></span><i class="ic i-angle-right"></i>
<span  class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/Projects/" itemprop="item" rel="index" title="In Projects"><span itemprop="name">Projects</span></a>
<meta itemprop="position" content="1" /></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="en">
  <link itemprop="mainEntityOfPage" href="http://hexlove2.github.io/2024/07/01/Projects/ChatWeb/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="Sunday">
    <meta itemprop="description" content="Looking for freedom of mind, Looking for freedom of mind">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hex">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h1 id="ChatWeb-project-notes"><a href="#ChatWeb-project-notes" class="headerlink" title="ChatWeb project notes"></a>ChatWeb project notes</h1><h2 id="Abstract"><a href="#Abstract" class="headerlink" title="Abstract:"></a>Abstract:</h2><p>**This page allows users to create an account and log in. Upon logging in, users enter a chat room where they can interact with other participants. Users can view the usernames and messages sent by others in real-time **</p>
<h2 id="1-Front-End"><a href="#1-Front-End" class="headerlink" title="1. Front-End"></a>1. Front-End</h2><p><img data-src="https://raw.githubusercontent.com/Hexlove2/images1/main/images/Screenshot%202024-07-07%20at%202.00.41%E2%80%AFPM.png" alt="Screenshot 2024-07-07 at 2.00.41 PM"></p>
<h3 id="1-Vue"><a href="#1-Vue" class="headerlink" title="1. Vue"></a>1. Vue</h3><p><strong>Note: The version of vue here I use is vue3.</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vue create chatwebfront</span><br><span class="line">npm install //modeules you need</span><br><span class="line">npm run server</span><br></pre></td></tr></table></figure>

<h4 id="1-Set-your-page"><a href="#1-Set-your-page" class="headerlink" title="1.Set your page"></a>1.Set your page</h4><p>First, you need to plan the entire structure of the website’s client side, including the layout of your home page. That’s why we need vue router. It controls page navigation and display. Here is my router setup.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createRouter, createWebHistory &#125; <span class="keyword">from</span> <span class="string">&#x27;vue-router&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">HomePage</span> <span class="keyword">from</span> <span class="string">&#x27;../components/HomePage.vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ChatRoom</span> <span class="keyword">from</span> <span class="string">&#x27;../components/ChatRoom.vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;HomePage&#x27;</span>, <span class="attr">component</span>: <span class="title class_">HomePage</span> &#125;,   <span class="comment">// 默认打开 HomePage 组件</span></span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;/chatroom/:username&#x27;</span>,<span class="attr">name</span>: <span class="string">&#x27;ChatRoom&#x27;</span>, <span class="attr">component</span>: <span class="title class_">ChatRoom</span> ,<span class="attr">props</span>: <span class="literal">true</span> &#125; <span class="comment">// ChatRoom 路径指向 ChatRoom 组件</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="title function_">createRouter</span>(&#123;</span><br><span class="line">  <span class="attr">history</span>: <span class="title function_">createWebHistory</span>(),</span><br><span class="line">  routes</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router</span><br></pre></td></tr></table></figure>

<p>Remember to import it in main.js too.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App.vue&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">&#x27;./router&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">createApp</span>(<span class="title class_">App</span>).<span class="title function_">use</span>(router).<span class="title function_">mount</span>(<span class="string">&#x27;#app&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="2-Coding-about-the-home-page"><a href="#2-Coding-about-the-home-page" class="headerlink" title="2. Coding about the home page."></a>2. Coding about the home page.</h4><p>Ok, before I show the code, let’s see what it looks like.</p>
<p><img data-src="https://raw.githubusercontent.com/Hexlove2/images1/main/images/Screenshot%202024-07-07%20at%202.31.00%E2%80%AFPM.png" alt="Screenshot 2024-07-07 at 2.31.00 PM"></p>
<p><img data-src="https://raw.githubusercontent.com/Hexlove2/images1/main/images/Screenshot%202024-07-07%20at%202.43.52%E2%80%AFPM.png" alt="Screenshot 2024-07-07 at 2.43.52 PM"></p>
<p>I don’t want to focus too much on how to design the page to make it look nice, the point is how it works, so I’ll skip the CSS part.</p>
<p>Let’s start with the register part. Input your username and password, then click the sign-up button. Obviously, the server needs to send your information to the back-end server called the HTTP server, here is the html part below.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span>  <span class="attr">placeholder</span>=<span class="string">&quot;Username&quot;</span> <span class="attr">v-model</span>=<span class="string">&quot;registerForm.username&quot;</span> /&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;Password&quot;</span> <span class="attr">v-model</span>=<span class="string">&quot;registerForm.password&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;email&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;E-Mail&quot;</span> <span class="attr">v-model</span>=<span class="string">&quot;registerForm.email&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;send_code&quot;</span>&gt;</span>Send Verification code<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;email&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;VERIFICATION CODE&quot;</span> <span class="attr">v-model</span>=<span class="string">&quot;registerForm.code&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>Sign Up<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>The v-model directive in Vue.js is used to create a two-way data binding on form inputs, textareas, and select elements. It ensures that the data in the Vue instance stays in sync with the input elements in the DOM. When the user updates the input, the bound data is automatically updated, and vice versa.</p>
<p>So, here is the js parts</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//data  </span></span><br><span class="line"><span class="attr">name</span>: <span class="string">&#x27;HomePage&#x27;</span>,</span><br><span class="line">  <span class="title function_">data</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">loginForm</span>: &#123;</span><br><span class="line">        <span class="attr">username</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="attr">password</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">registerForm</span>: &#123;</span><br><span class="line">        <span class="attr">username</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="attr">password</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="attr">email</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="attr">code</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//add click event </span></span><br><span class="line"><span class="title function_">mounted</span>(<span class="params"></span>) &#123;</span><br><span class="line">   <span class="keyword">const</span> container = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#container&#x27;</span>);</span><br><span class="line">   <span class="keyword">const</span> signInButton = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#signIn&#x27;</span>);</span><br><span class="line">   <span class="keyword">const</span> signUpButton = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#signUp&#x27;</span>);</span><br><span class="line"></span><br><span class="line">   signUpButton.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>,<span class="function">() =&gt;</span> container.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&#x27;right-panel-active&#x27;</span>))</span><br><span class="line">   signInButton.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>,<span class="function">() =&gt;</span> container.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&#x27;right-panel-active&#x27;</span>))</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">//try to register</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">     <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&#x27;http://192.168.31.137:9176/register&#x27;</span>, &#123;</span><br><span class="line">       <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">       <span class="attr">headers</span>: &#123;</span><br><span class="line">         <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span></span><br><span class="line">       &#125;,</span><br><span class="line">       <span class="attr">body</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">this</span>.<span class="property">registerForm</span>)</span><br><span class="line">     &#125;);</span><br><span class="line">     <span class="keyword">const</span> result = <span class="keyword">await</span> response.<span class="title function_">json</span>();    </span><br><span class="line">             <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;register_username&#x27;</span>).<span class="property">innerText</span> = result.<span class="property">message</span>;</span><br><span class="line">             <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;register_username&#x27;</span>).<span class="property">style</span>.<span class="property">color</span> = <span class="string">&#x27;pink&#x27;</span>; <span class="comment">// 可选：改变文字颜色</span></span><br><span class="line"></span><br><span class="line">     <span class="comment">// 处理后端响应</span></span><br><span class="line">     <span class="keyword">if</span>(result.<span class="property">status</span>===<span class="string">&#x27;success&#x27;</span>)</span><br><span class="line">       <span class="variable language_">this</span>.<span class="title function_">showRegisterText</span>(<span class="string">&#x27;Register Success!&#x27;</span>,<span class="number">0</span>);       </span><br><span class="line">     <span class="variable language_">console</span>.<span class="title function_">log</span>(result);</span><br><span class="line">   &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">     <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;注册失败:&#x27;</span>, error);</span><br><span class="line">     <span class="variable language_">this</span>.<span class="title function_">showRegisterText</span>(<span class="string">&#x27;Register Failed&#x27;</span>,<span class="number">1</span>);</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;,</span><br></pre></td></tr></table></figure>

<p>You can see that I used the fetch function to send the message in json format, It’s a POST HTTP request. Then I can receive the message from the HTTP server if everything about NET was okay. The status of the result should be success.</p>
<p>The part about how back-end handles this request will be shown in the back-end section below.</p>
<p>Here is the login part.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">login</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;waiting0...&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&#x27;http://192.168.31.137:9176/login&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">      <span class="attr">headers</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">body</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">this</span>.<span class="property">loginForm</span>)</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 打印响应的状态码和内容类型</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;响应状态码:&#x27;</span>, response.<span class="property">status</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;响应内容类型:&#x27;</span>, response.<span class="property">headers</span>.<span class="title function_">get</span>(<span class="string">&#x27;content-type&#x27;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查响应内容</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将响应文本解析为JSON</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> response.<span class="title function_">json</span>(); </span><br><span class="line">            <span class="comment">// 更新并显示错误消息</span></span><br><span class="line">            <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;loginresult&#x27;</span>).<span class="property">innerText</span> = result.<span class="property">message</span>;</span><br><span class="line">            <span class="keyword">if</span>(result.<span class="property">status</span>===<span class="string">&#x27;error&#x27;</span>)</span><br><span class="line">              <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;loginresult&#x27;</span>).<span class="property">style</span>.<span class="property">color</span> = <span class="string">&#x27;red&#x27;</span>; <span class="comment">// 可选：改变文字颜色</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">              <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;loginresult&#x27;</span>).<span class="property">style</span>.<span class="property">color</span> = <span class="string">&#x27;blue&#x27;</span>; <span class="comment">// 可选：改变文字颜色</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">showRegisterText</span>();          </span><br><span class="line">    <span class="keyword">if</span> (result.<span class="property">status</span> === <span class="string">&#x27;success&#x27;</span>)</span><br><span class="line">      <span class="comment">// 假设在登录成功后的处理函数中</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">$router</span>.<span class="title function_">push</span>(&#123; <span class="attr">name</span>: <span class="string">&#x27;ChatRoom&#x27;</span>, <span class="attr">params</span>: &#123; <span class="attr">username</span>: <span class="variable language_">this</span>.<span class="property">loginForm</span>.<span class="property">username</span> &#125; &#125;);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(result);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;登录失败:&#x27;</span>, error);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">showLoginErrorText</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>If the back-end responds with a success message, the router will navigate to another page: the Chat room.</p>
<h4 id="3-Coding-about-the-chat-room"><a href="#3-Coding-about-the-chat-room" class="headerlink" title="3. Coding about the chat room"></a>3. Coding about the chat room</h4><p>The chat room looks like this.</p>
<img data-src="https://raw.githubusercontent.com/Hexlove2/images1/main/images/Screenshot%202024-07-07%20at%203.21.49%E2%80%AFPM.png" width="500">

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;chat-container-chatroom&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Welcome to the Chat Room<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;video-container&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">video</span> <span class="attr">ref</span>=<span class="string">&quot;localVideo&quot;</span> <span class="attr">autoplay</span> <span class="attr">muted</span>&gt;</span><span class="tag">&lt;/<span class="name">video</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">video</span> <span class="attr">ref</span>=<span class="string">&quot;remoteVideo&quot;</span> <span class="attr">autoplay</span>&gt;</span><span class="tag">&lt;/<span class="name">video</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;messages-chatroom&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-for</span>=<span class="string">&quot;(message, index) in messages&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;index&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;username-chatroom&quot;</span> <span class="attr">v-html</span>=<span class="string">&quot;message.username&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;message-content-chatroom&quot;</span> <span class="attr">v-html</span>=<span class="string">&quot;message.content&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;input-container-chatroom&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">v-model</span>=<span class="string">&quot;newMessage&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;Type your message here...&quot;</span> @<span class="attr">keypress.enter</span>=<span class="string">&quot;sendMessage&quot;</span> @<span class="attr">input</span>=<span class="string">&quot;handleInput&quot;</span> &gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;sendMessage&quot;</span>&gt;</span>Send<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;video-buttons&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;videostart&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;startVideo&quot;</span> &gt;</span>StartVideo<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;videohangup&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;stopVideo&quot;</span>&gt;</span>Hangup<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Okay, the point is, how does the server send each message to every client in this room?</p>
<p>If you want to transfer messages between a server and a web-based client, it’s convenient to use WebSocket, but how? Well, the good news is it’s easy to use it on the Front-End.</p>
<p>First, you need to connect to the server in advance, send a HTTP request to upgrade the protocol from http to websocket. So you can code like this.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">created()&#123;</span><br><span class="line">  this.connectWebSocket();</span><br><span class="line">  window.addEventListener(&#x27;beforeunload&#x27;, function () &#123;</span><br><span class="line">  if (this.socket &amp;&amp; this.socket.readyState === WebSocket.OPEN) &#123;</span><br><span class="line">      this.socket.close();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">connectWebSocket()&#123;</span><br><span class="line">  this.socket = new WebSocket(&#x27;ws://192.168.31.137:7777&#x27;);</span><br><span class="line"></span><br><span class="line">  this.socket.onopen = () =&gt; &#123;</span><br><span class="line">      console.log(&#x27;WebSocket connection opened&#x27;);</span><br><span class="line">      //this.socket.send(&#x27;Hello!&#x27;);</span><br><span class="line">      console.log(&#x27;已发送hello消息&#x27;);</span><br><span class="line">  &#125;;</span><br><span class="line">  this.socket.onmessage = (event) =&gt;&#123;</span><br><span class="line">   		const data= JSON.parse(event.data);      </span><br><span class="line">      this.messages.push(data);</span><br><span class="line">      this.$nextTick(()=&gt;&#123;</span><br><span class="line">        this.scrollToBottom();</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;;        </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>You’ll send a POST request to server when you use WebSocket. The server will then understand that it’s a handshake request and send the correct response back.</p>
<p>Now that the protocol has upgraded to websocket, it’s time to communicate with each end.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">  <span class="title function_">sendMessage</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">newMessage</span>.<span class="title function_">trim</span>() !== <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> message = &#123;</span><br><span class="line">      <span class="attr">username</span>: <span class="string">`&lt;span style=&quot;color: blue;&quot;&gt;[<span class="subst">$&#123;<span class="variable language_">this</span>.username&#125;</span>]&lt;/span&gt;`</span>,</span><br><span class="line">      <span class="attr">content</span>: <span class="variable language_">this</span>.<span class="property">newMessage</span>.<span class="title function_">trim</span>() <span class="comment">// Trim whitespace properly</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">messages</span>.<span class="title function_">push</span>(message);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Prepared message to send:&#x27;</span>, message); <span class="comment">// Log the message</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">socket</span>.<span class="property">readyState</span> === <span class="title class_">WebSocket</span>.<span class="property">OPEN</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> jsonMessage = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(message);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;JSON message to send:&#x27;</span>, jsonMessage); <span class="comment">// Log the JSON message</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">socket</span>.<span class="title function_">send</span>(jsonMessage);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Message sent:&#x27;</span>, message);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Failed to send message:&#x27;</span>, error);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;WebSocket is not open. Ready state is:&#x27;</span>, <span class="variable language_">this</span>.<span class="property">socket</span>.<span class="property">readyState</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">newMessage</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="variable language_">this</span>.$nextTick(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">scrollToBottom</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;New message is empty or only whitespace&#x27;</span>); <span class="comment">// Log if newMessage is empty or whitespace</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-Webrtc"><a href="#2-Webrtc" class="headerlink" title="2. Webrtc"></a>2. Webrtc</h3><p>To be continued.</p>
<h2 id="2-Back-End"><a href="#2-Back-End" class="headerlink" title="2. Back-End"></a>2. Back-End</h2><h3 id="1-HTTP-Server"><a href="#1-HTTP-Server" class="headerlink" title="1. HTTP Server"></a>1. HTTP Server</h3><h4 id="1-Preprocessor"><a href="#1-Preprocessor" class="headerlink" title="1. Preprocessor"></a>1. Preprocessor</h4><p>The Http server is used to receive http request and response correctly, for example, it can check if the username and password provided by the POST request match the records in the mysql database.</p>
<p>The server I developed uses multiple threads to handle each client who connects to the server. (It’s not ideal, as I should use a thread pool instead of creating a new thread for each client)</p>
<p>Here is the main function and other functions.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;mysql.c&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUF_SIZE 1024</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SMALL_BUF 1024</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">handle_request</span><span class="params">(<span class="type">int</span> client_sock)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">error_handling</span><span class="params">(<span class="type">char</span> *message)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">send_response</span><span class="params">(<span class="type">int</span> clnt_sock, <span class="type">const</span> <span class="type">char</span> *message)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">extract_value</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *json, <span class="type">const</span> <span class="type">char</span> *key, <span class="type">char</span> *value, <span class="type">size_t</span> value_size)</span>;</span><br><span class="line"><span class="type">bool</span> <span class="title function_">login_request</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *body, <span class="type">const</span> <span class="type">int</span> sock)</span>;</span><br><span class="line"><span class="type">bool</span> <span class="title function_">register_request</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *body, <span class="type">const</span> <span class="type">int</span> sock)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="type">int</span> serv_sock, clnt_sock;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serv_adr</span>, <span class="title">clnt_adr</span>;</span></span><br><span class="line">    <span class="type">socklen_t</span> clnt_adr_sz;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(argc!=<span class="number">2</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Usage: %s &lt;port&gt;\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    serv_sock=socket(PF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(serv_sock == <span class="number">-1</span>)</span><br><span class="line">        error_handling(<span class="string">&quot;socket() error&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;serv_adr, <span class="number">0</span>, <span class="keyword">sizeof</span>(serv_adr));</span><br><span class="line">    serv_adr.sin_family=AF_INET;</span><br><span class="line">    serv_adr.sin_addr.s_addr=htonl(INADDR_ANY);</span><br><span class="line">    serv_adr.sin_port=htons(atoi(argv[<span class="number">1</span>]));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(bind(serv_sock, (<span class="keyword">struct</span> sockaddr*) &amp;serv_adr, <span class="keyword">sizeof</span>(serv_adr))==<span class="number">-1</span>)</span><br><span class="line">        error_handling(<span class="string">&quot;bind() error&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(listen(serv_sock, <span class="number">5</span>)==<span class="number">-1</span>)</span><br><span class="line">        error_handling(<span class="string">&quot;listen() error&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        clnt_adr_sz=<span class="keyword">sizeof</span>(clnt_adr);</span><br><span class="line">        clnt_sock=accept(serv_sock, (<span class="keyword">struct</span> sockaddr*)&amp;clnt_adr, &amp;clnt_adr_sz);</span><br><span class="line">        <span class="keyword">if</span>(clnt_sock==<span class="number">-1</span>)</span><br><span class="line">            error_handling(<span class="string">&quot;accept() error&quot;</span>);</span><br><span class="line"></span><br><span class="line">        handle_request(clnt_sock);</span><br><span class="line">        close(clnt_sock);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    close(serv_sock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Now let’s see how the handle_request function works.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">handle_request</span><span class="params">(<span class="type">int</span> clnt_sock)</span> &#123;</span><br><span class="line">    <span class="type">char</span> req_line[SMALL_BUF];</span><br><span class="line">    <span class="type">char</span> method[<span class="number">10</span>];</span><br><span class="line">    <span class="type">char</span> content_length[SMALL_BUF];</span><br><span class="line">    <span class="type">char</span> content_type[SMALL_BUF];</span><br><span class="line">    <span class="type">char</span> header[SMALL_BUF];</span><br><span class="line">    <span class="type">int</span> str_len, length = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Reading the request line</span></span><br><span class="line">    <span class="type">int</span> idx = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="type">char</span> c;</span><br><span class="line">        <span class="keyword">if</span> (read(clnt_sock, &amp;c, <span class="number">1</span>) &lt;= <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">        req_line[idx++] = c;</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="string">&#x27;\n&#x27;</span>) <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    req_line[idx] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Parsing the HTTP method from the request line</span></span><br><span class="line">    <span class="built_in">sscanf</span>(req_line, <span class="string">&quot;%s&quot;</span>, method);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;********************************************************************* \n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>,req_line);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;********************************************************************* \n&quot;</span>);</span><br><span class="line">    <span class="comment">// Handling the OPTIONS request (preflight request for CORS)</span></span><br><span class="line">  	<span class="comment">// Beacuse the request sent by front end is json type</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(method, <span class="string">&quot;OPTIONS&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">char</span> response[] =</span><br><span class="line">            <span class="string">&quot;HTTP/1.1 204 No Content\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;Access-Control-Allow-Origin: *\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;Access-Control-Allow-Methods: POST, GET, OPTIONS\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;Access-Control-Allow-Headers: Content-Type\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">        write(clnt_sock, response, <span class="keyword">sizeof</span>(response) - <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;CORS SUCCESS \n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Handling only POST requests</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(method, <span class="string">&quot;POST&quot;</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">        send_response(clnt_sock, <span class="string">&quot;HTTP/1.1 405 Method Not Allowed\r\n\r\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 逐行读取请求头</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        idx = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="type">char</span> c;</span><br><span class="line">            <span class="keyword">if</span> (read(clnt_sock, &amp;c, <span class="number">1</span>) &lt;= <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">            header[idx++] = c;</span><br><span class="line">            <span class="keyword">if</span> (c == <span class="string">&#x27;\n&#x27;</span>) <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        header[idx] = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(header, <span class="string">&quot;\r\n&quot;</span>) == <span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Header: %s&quot;</span>, header);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strstr</span>(header, <span class="string">&quot;Content-Length&quot;</span>) != <span class="literal">NULL</span>)</span><br><span class="line">            <span class="built_in">sscanf</span>(header, <span class="string">&quot;Content-Length: %d&quot;</span>, &amp;length);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (length == <span class="number">0</span>) &#123;</span><br><span class="line">        send_response(clnt_sock, <span class="string">&quot;HTTP/1.1 411 Length Required\r\n\r\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Reading the body based on Content-Length</span></span><br><span class="line">    <span class="type">char</span> *body = <span class="built_in">malloc</span>(length + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (body == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        send_response(clnt_sock, <span class="string">&quot;HTTP/1.1 500 Internal Server Error\r\n\r\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> total_read = <span class="number">0</span>, n;</span><br><span class="line">    <span class="keyword">while</span> (total_read &lt; length) &#123;</span><br><span class="line">        n = read(clnt_sock, body + total_read, length - total_read);</span><br><span class="line">        <span class="keyword">if</span> (n &lt;= <span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line">        total_read += n;</span><br><span class="line">    &#125;</span><br><span class="line">    body[total_read] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Received Body: %s\n&quot;</span>, body);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Process the received data (e.g., parse JSON, handle login logic, etc.)</span></span><br><span class="line">    <span class="comment">// Placeholder for JSON parsing and login logic</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//login request</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">strstr</span>(req_line,<span class="string">&quot;login&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">     <span class="keyword">if</span>(login_request(body,clnt_sock))</span><br><span class="line">     &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Login success \n&quot;</span>);        </span><br><span class="line">     &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//register request</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strstr</span>(req_line,<span class="string">&quot;register&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">     <span class="keyword">if</span>(register_request(body,clnt_sock))</span><br><span class="line">     &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;register success\n&quot;</span>);</span><br><span class="line">     &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Ending............................................................\n&quot;</span>);</span><br><span class="line">    <span class="comment">//fflush(stdout);</span></span><br><span class="line">    <span class="comment">// Sending the response</span></span><br><span class="line">    <span class="comment">// Free the allocated memory for the body</span></span><br><span class="line">    <span class="built_in">free</span>(body);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Here is the output of the back-end terminal.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">********************************************************************* </span><br><span class="line">OPTIONS /login HTTP/1.1</span><br><span class="line">********************************************************************* </span><br><span class="line">CORS SUCCESS </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">********************************************************************* </span><br><span class="line">POST /login HTTP/1.1</span><br><span class="line">********************************************************************* </span><br><span class="line">Header: Host: 192.168.31.137:9176</span><br><span class="line">Header: Content-Type: application/json</span><br><span class="line">Header: Origin: http://localhost:8080</span><br><span class="line">Header: Accept-Encoding: gzip, deflate</span><br><span class="line">Header: Connection: keep-alive</span><br><span class="line">Header: Accept: */*</span><br><span class="line">Header: User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.4.1 Safari/605.1.15</span><br><span class="line">Header: Referer: http://localhost:8080/</span><br><span class="line">Header: Content-Length: 41</span><br><span class="line">Header: Accept-Language: en-US,en;q=0.9</span><br><span class="line">Received Body: &#123;<span class="string">&quot;username&quot;</span>:<span class="string">&quot;Sunday&quot;</span>,<span class="string">&quot;password&quot;</span>:<span class="string">&quot;123456&quot;</span>&#125;</span><br><span class="line">Body内容:&#123;<span class="string">&quot;username&quot;</span>:<span class="string">&quot;Sunday&quot;</span>,<span class="string">&quot;password&quot;</span>:<span class="string">&quot;123456&quot;</span>&#125; </span><br><span class="line">Username: Sunday</span><br><span class="line">Password: 123456</span><br><span class="line">password from Web:123456</span><br><span class="line">password from Mysql:123456</span><br><span class="line">check successed</span><br><span class="line">login success </span><br><span class="line">Login success </span><br><span class="line">Ending............................................................</span><br></pre></td></tr></table></figure>

<p>So we got the username and password, how to check them in MYSQL?</p>
<h4 id="2-Usage-of-MySql"><a href="#2-Usage-of-MySql" class="headerlink" title="2. Usage of MySql"></a>2. Usage of MySql</h4><p>Here are three functions created in mysql.c.</p>
<p>You need to know some mysql statements to understand these funcs.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> <span class="title function_">user_search</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *username)</span>;</span><br><span class="line"><span class="type">bool</span> <span class="title function_">password_check</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *username, <span class="type">const</span> <span class="type">char</span> *password)</span>;</span><br><span class="line"><span class="type">bool</span> <span class="title function_">register_mysql</span><span class="params">(<span class="type">char</span> *username, <span class="type">char</span> *password)</span>;</span><br></pre></td></tr></table></figure>

<p>The first one is user search.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mysql/mysql.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 函数声明：user_search，用于在数据库中查找用户名</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">user_search</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *username)</span></span><br><span class="line">&#123;   </span><br><span class="line">    MYSQL *conn;      <span class="comment">// MySQL 连接句柄</span></span><br><span class="line">    MYSQL_RES *res;   <span class="comment">// 查询结果集</span></span><br><span class="line">    MYSQL_ROW row;    <span class="comment">// 行数据</span></span><br><span class="line">    </span><br><span class="line">    <span class="type">char</span> query[<span class="number">256</span>];  <span class="comment">// 存储 SQL 查询的字符串</span></span><br><span class="line">    <span class="comment">// 使用 snprintf 函数格式化查询字符串，将输入的用户名嵌入到查询中</span></span><br><span class="line">    <span class="built_in">snprintf</span>(query, <span class="keyword">sizeof</span>(query), <span class="string">&quot;SELECT username FROM clients WHERE username=&#x27;%s&#x27;&quot;</span>, username);</span><br><span class="line"></span><br><span class="line">    conn = mysql_init(<span class="literal">NULL</span>);  <span class="comment">// 初始化 MySQL 连接句柄</span></span><br><span class="line">    <span class="keyword">if</span> (conn == <span class="literal">NULL</span>) &#123;  <span class="comment">// 检查初始化是否成功</span></span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;mysql_init() failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;  <span class="comment">// 如果初始化失败，返回 false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 连接到 MySQL 数据库，指定主机名、用户名、密码、数据库名和端口号</span></span><br><span class="line">    <span class="keyword">if</span> (mysql_real_connect(conn, <span class="string">&quot;localhost&quot;</span>, <span class="string">&quot;chat&quot;</span>, <span class="string">&quot;123456&quot;</span>, <span class="string">&quot;ChatClient&quot;</span>, <span class="number">3306</span>, <span class="literal">NULL</span>, <span class="number">0</span>) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;mysql_real_connect() failed\n&quot;</span>);</span><br><span class="line">        mysql_close(conn);  <span class="comment">// 关闭 MySQL 连接</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;  <span class="comment">// 如果连接失败，返回 false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行查询，检查查询是否成功</span></span><br><span class="line">    <span class="keyword">if</span> (mysql_query(conn, query)) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;SELECT error: %s\n&quot;</span>, mysql_error(conn));</span><br><span class="line">        mysql_close(conn);  <span class="comment">// 关闭 MySQL 连接</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;  <span class="comment">// 如果查询失败，返回 false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 存储查询结果</span></span><br><span class="line">    res = mysql_store_result(conn);</span><br><span class="line">    <span class="keyword">if</span> (res == <span class="literal">NULL</span>) &#123;  <span class="comment">// 检查结果是否成功存储</span></span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;mysql_store_result() failed\n&quot;</span>);</span><br><span class="line">        mysql_close(conn);  <span class="comment">// 关闭 MySQL 连接</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;  <span class="comment">// 如果存储结果失败，返回 false</span></span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="comment">// 返回查询结果中行数是否大于0，如果有匹配的用户名返回 true，否则返回 false</span></span><br><span class="line">    <span class="keyword">return</span> (mysql_num_rows(res) &gt; <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The next function is password check. It’s very easy to understand if you have comprehended the previous function.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> <span class="title function_">password_check</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *username, <span class="type">const</span> <span class="type">char</span> *password)</span></span><br><span class="line">&#123;</span><br><span class="line">    MYSQL *conn;</span><br><span class="line">    MYSQL_RES *res;</span><br><span class="line">    MYSQL_ROW row;</span><br><span class="line">    <span class="type">bool</span> checkresult;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> query[<span class="number">256</span>];</span><br><span class="line">    <span class="built_in">snprintf</span>(query,<span class="keyword">sizeof</span>(query), <span class="string">&quot;SELECT password FROM clients WHERE username=&#x27;%s&#x27;&quot;</span>,username);</span><br><span class="line">    conn=mysql_init(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span>(conn==<span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">&quot;mysql_init error\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(mysql_real_connect(conn,<span class="string">&quot;localhost&quot;</span>,<span class="string">&quot;chat&quot;</span>,<span class="string">&quot;123456&quot;</span>,<span class="string">&quot;ChatClient&quot;</span>,<span class="number">3306</span>, <span class="literal">NULL</span>, <span class="number">0</span>)==<span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">&quot;mysql_real_connect error\n&quot;</span>);</span><br><span class="line">        mysql_close(conn);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(mysql_query(conn,query))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Select Error: %s\n&quot;</span>, mysql_error(conn));</span><br><span class="line">        mysql_close(conn);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    res=mysql_store_result(conn);</span><br><span class="line">    <span class="keyword">if</span>(res==<span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;mysql_store_result erro\n&quot;</span>);</span><br><span class="line">        mysql_close(conn);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    row=mysql_fetch_row(res);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;password from Web:%s\n&quot;</span>,password);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;password from Mysql:%s\n&quot;</span>,row[<span class="number">0</span>]);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(row[<span class="number">0</span>],password))</span><br><span class="line">        checkresult = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        checkresult = <span class="literal">false</span>;</span><br><span class="line">    mysql_free_result(res);</span><br><span class="line">    mysql_close(conn);</span><br><span class="line">    <span class="keyword">if</span>(checkresult)</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;check successed\n&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;check failed\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> checkresult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Last but not least.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> <span class="title function_">register_mysql</span><span class="params">(<span class="type">char</span> *username, <span class="type">char</span> *password)</span></span><br><span class="line">&#123;</span><br><span class="line">    MYSQL *conn;</span><br><span class="line">    <span class="type">char</span> query[<span class="number">256</span>];</span><br><span class="line"></span><br><span class="line">    conn=mysql_init(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span>(conn == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">&quot;mysql_init error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(mysql_real_connect(conn,<span class="string">&quot;localhost&quot;</span>, <span class="string">&quot;chat&quot;</span>, <span class="string">&quot;123456&quot;</span>, <span class="string">&quot;ChatClient&quot;</span>,<span class="number">3306</span>, <span class="literal">NULL</span>, <span class="number">0</span>)==<span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;mysql_real_connect error&quot;</span>);</span><br><span class="line">        mysql_close(conn);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">snprintf</span>(query,<span class="keyword">sizeof</span>(query),<span class="string">&quot;INSERT INTO clients (username, password) VALUES (&#x27;%s&#x27;, &#x27;%s&#x27;)&quot;</span>,username,password);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(mysql_query(conn,query))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">&quot;mysql_query error&quot;</span>);</span><br><span class="line">        mysql_close(conn);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-Data-Match-x2F-Insert"><a href="#3-Data-Match-x2F-Insert" class="headerlink" title="3. Data Match&#x2F;Insert"></a>3. Data Match&#x2F;Insert</h4><p>Here is a function that can extract the body message from a Json format string like this.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Received Body: &#123;<span class="string">&quot;username&quot;</span>:<span class="string">&quot;Sunday&quot;</span>,<span class="string">&quot;password&quot;</span>:<span class="string">&quot;123456&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">extract_value</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *json, <span class="type">const</span> <span class="type">char</span> *key, <span class="type">char</span> *value, <span class="type">size_t</span> value_size)</span> &#123;</span><br><span class="line">    <span class="type">char</span> *key_pos = <span class="built_in">strstr</span>(json, key);</span><br><span class="line">    <span class="keyword">if</span> (key_pos != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        key_pos = <span class="built_in">strchr</span>(key_pos, <span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (key_pos != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            key_pos++;</span><br><span class="line">            <span class="keyword">while</span> (*key_pos == <span class="string">&#x27; &#x27;</span> || *key_pos == <span class="string">&#x27;&quot;&#x27;</span>) &#123;</span><br><span class="line">                key_pos++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">char</span> *end_pos = <span class="built_in">strchr</span>(key_pos, <span class="string">&#x27;&quot;&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> (end_pos != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="type">size_t</span> len = end_pos - key_pos;</span><br><span class="line">                <span class="keyword">if</span> (len &lt; value_size) &#123;</span><br><span class="line">                    <span class="built_in">strncpy</span>(value, key_pos, len);</span><br><span class="line">                    value[len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">strncpy</span>(value, key_pos, value_size - <span class="number">1</span>);</span><br><span class="line">                    value[value_size - <span class="number">1</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 如果没有找到结束引号，则值可能为空字符串</span></span><br><span class="line">                value[<span class="number">0</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果没有找到冒号，则值可能为空字符串</span></span><br><span class="line">            value[<span class="number">0</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果没有找到键，则值可能为空字符串</span></span><br><span class="line">        value[<span class="number">0</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Then you can get the username and password.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Username: Sunday</span><br><span class="line">Password: 123456</span><br></pre></td></tr></table></figure>

<p>So it’s time to check them in mysql and response correctly.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> <span class="title function_">login_request</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *body, <span class="type">const</span> <span class="type">int</span> sock)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> username[<span class="number">10</span>];</span><br><span class="line">    <span class="type">char</span> password[<span class="number">30</span>];</span><br><span class="line">    <span class="comment">// 提取用户名和密码</span></span><br><span class="line">    extract_value(body, <span class="string">&quot;username&quot;</span>, username, <span class="keyword">sizeof</span>(username));</span><br><span class="line">    extract_value(body, <span class="string">&quot;password&quot;</span>, password, <span class="keyword">sizeof</span>(password));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Body内容:%s \n&quot;</span>,body);</span><br><span class="line">    <span class="comment">// 打印提取的用户名和密码</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Username: %s\n&quot;</span>, username);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Password: %s\n&quot;</span>, password);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(user_search(username))</span><br><span class="line">    &#123;</span><br><span class="line">     <span class="keyword">if</span>(password_check(username, password))</span><br><span class="line">     &#123;</span><br><span class="line">        <span class="type">char</span> response[] =</span><br><span class="line">            <span class="string">&quot;HTTP/1.1 200 OK\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;Content-Type: application/json\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;Access-Control-Allow-Origin: *\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;&#123;\&quot;status\&quot;:\&quot;success\&quot;, \&quot;message\&quot;:\&quot;Login Success\&quot;&#125;&quot;</span>;</span><br><span class="line">        send_response(sock, response);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;login success \n&quot;</span>);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">else</span></span><br><span class="line">     &#123;</span><br><span class="line">        <span class="type">char</span> response[] =</span><br><span class="line">            <span class="string">&quot;HTTP/1.1 401 Unauthorized\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;Content-Type: application/json\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;Access-Control-Allow-Origin: *\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;&#123;\&quot;status\&quot;:\&quot;error\&quot;, \&quot;message\&quot;:\&quot;Password Wrong\&quot;&#125;&quot;</span>;</span><br><span class="line">        send_response(sock, response);</span><br><span class="line">     &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> response[] =</span><br><span class="line">        <span class="string">&quot;HTTP/1.1 401 Unauthorized\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Content-Type: application/json\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Access-Control-Allow-Origin: *\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;&#123;\&quot;status\&quot;:\&quot;error\&quot;, \&quot;message\&quot;:\&quot;Username does not exists\&quot;&#125;&quot;</span>;</span><br><span class="line">        send_response(sock, response);       </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> <span class="title function_">register_request</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *body, <span class="type">const</span> <span class="type">int</span> sock)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> username[<span class="number">10</span>];</span><br><span class="line">    <span class="type">char</span> password[<span class="number">30</span>];</span><br><span class="line"></span><br><span class="line">    extract_value(body, <span class="string">&quot;username&quot;</span>, username, <span class="keyword">sizeof</span>(username));</span><br><span class="line">    extract_value(body, <span class="string">&quot;password&quot;</span>, password, <span class="keyword">sizeof</span>(password));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Body内容:%s \n&quot;</span>,body);</span><br><span class="line">    <span class="comment">// 打印提取的用户名和密码</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Username: %s\n&quot;</span>, username);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Password: %s\n&quot;</span>, password);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">strstr</span>(body,<span class="string">&quot;\&quot;username\&quot;:\&quot;\&quot;&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> response[] =</span><br><span class="line">        <span class="string">&quot;HTTP/1.1 401 Unauthorized\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Content-Type: application/json\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Access-Control-Allow-Origin: *\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;&#123;\&quot;status\&quot;:\&quot;error\&quot;, \&quot;message\&quot;:\&quot;Username can not be empty\&quot;&#125;&quot;</span>;</span><br><span class="line">        send_response(sock, response);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Username Empty\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">strstr</span>(body,<span class="string">&quot;\&quot;password\&quot;:\&quot;\&quot;&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> response[] =</span><br><span class="line">        <span class="string">&quot;HTTP/1.1 401 Unauthorized\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Content-Type: application/json\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Access-Control-Allow-Origin: *\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;&#123;\&quot;status\&quot;:\&quot;error\&quot;, \&quot;message\&quot;:\&quot;Password can not be empty\&quot;&#125;&quot;</span>;</span><br><span class="line">        send_response(sock, response);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Password Empty\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;        </span><br><span class="line">    &#125;   </span><br><span class="line">    <span class="keyword">if</span>(user_search(username))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> response[] =</span><br><span class="line">        <span class="string">&quot;HTTP/1.1 401 Unauthorized\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Content-Type: application/json\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Access-Control-Allow-Origin: *\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;&#123;\&quot;status\&quot;:\&quot;error\&quot;, \&quot;message\&quot;:\&quot;Username already exists\&quot;&#125;&quot;</span>;</span><br><span class="line">        send_response(sock, response);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Username already exists\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(register_mysql(username,password))</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;注册成功 \n&quot;</span>);</span><br><span class="line">        <span class="type">char</span> response[] =</span><br><span class="line">        <span class="string">&quot;HTTP/1.1 200 Unauthorized\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Content-Type: application/json\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Access-Control-Allow-Origin: *\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;&#123;\&quot;status\&quot;:\&quot;success\&quot;, \&quot;message\&quot;:\&quot;恭喜🎉:注册成功\&quot;&#125;&quot;</span>;</span><br><span class="line">        send_response(sock, response);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Register Success\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//fflush(stdout);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">send_response</span><span class="params">(<span class="type">int</span> clnt_sock, <span class="type">const</span> <span class="type">char</span> *message)</span> &#123;</span><br><span class="line">    write(clnt_sock, message, <span class="built_in">strlen</span>(message));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-Chat-Server"><a href="#2-Chat-Server" class="headerlink" title="2. Chat Server"></a>2. Chat Server</h3><p>Okay, here is the most important part: Chat Server.</p>
<p>Before I introduce the functions, let’s see what we would receive in the back-end.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">connected client: 5 </span><br><span class="line">msg大小为:2048,str_len大小为:489 </span><br><span class="line">收到的原消息为: GET / HTTP/1.1</span><br><span class="line">Host: 192.168.31.137:7777</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Accept: */*</span><br><span class="line">Sec-WebSocket-Key: js+9AYMdpJsh9rhL87453g==</span><br><span class="line">Sec-WebSocket-Version: 13</span><br><span class="line">Accept-Language: en-US,en;q=0.9</span><br><span class="line">Sec-WebSocket-Extensions: permessage-deflate</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Origin: http://localhost:8080</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.4.1 Safari/605.1.15</span><br><span class="line">Connection: Upgrade</span><br><span class="line">Upgrade: websocket</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">开始握手</span><br><span class="line">拼接完成的str为:js+9AYMdpJsh9rhL87453g==258EAFA5-E914-47DA-95CA-C5AB0DC85B11 </span><br><span class="line">msg大小为:2048,str_len大小为:83 </span><br><span class="line">解码后的消息: &#123;<span class="string">&quot;username&quot;</span>:<span class="string">&quot;&lt;span style=\&quot;color: blue;\&quot;&gt;[Sunday]&lt;/span&gt;&quot;</span>,<span class="string">&quot;content&quot;</span>:<span class="string">&quot;hello&quot;</span>&#125;</span><br><span class="line">解码后的消息为: &#123;<span class="string">&quot;username&quot;</span>:<span class="string">&quot;&lt;span style=\&quot;color: blue;\&quot;&gt;[Sunday]&lt;/span&gt;&quot;</span>,<span class="string">&quot;content&quot;</span>:<span class="string">&quot;hello&quot;</span>&#125;</span><br><span class="line">msg大小为:2048,str_len大小为:77 </span><br><span class="line">解码后的消息: &#123;<span class="string">&quot;username&quot;</span>:<span class="string">&quot;&lt;span style=\&quot;color: blue;\&quot;&gt;[Xyh]&lt;/span&gt;&quot;</span>,<span class="string">&quot;content&quot;</span>:<span class="string">&quot;hi&quot;</span>&#125;</span><br><span class="line">解码后的消息为: &#123;<span class="string">&quot;username&quot;</span>:<span class="string">&quot;&lt;span style=\&quot;color: blue;\&quot;&gt;[Xyh]&lt;/span&gt;&quot;</span>,<span class="string">&quot;content&quot;</span>:<span class="string">&quot;hi&quot;</span>&#125;</span><br><span class="line">msg大小为:2048,str_len大小为:78 </span><br><span class="line">解码后的消息: &#123;<span class="string">&quot;username&quot;</span>:<span class="string">&quot;&lt;span style=\&quot;color: blue;\&quot;&gt;[Xyh]&lt;/span&gt;&quot;</span>,<span class="string">&quot;content&quot;</span>:<span class="string">&quot;hey&quot;</span>&#125;</span><br><span class="line">解码后的消息为: &#123;<span class="string">&quot;username&quot;</span>:<span class="string">&quot;&lt;span style=\&quot;color: blue;\&quot;&gt;[Xyh]&lt;/span&gt;&quot;</span>,<span class="string">&quot;content&quot;</span>:<span class="string">&quot;hey&quot;</span>&#125;</span><br><span class="line">^C</span><br></pre></td></tr></table></figure>

<p>Okay, it’s a little complicit for beginners, I will explain this step by step.</p>
<p>First, what happens if the clients log in successfully and then enter the chatroom? Yes, the websocket function will send an HTTP request to the server to upgrade the protocol from http to websocket. So, how does it work?</p>
<p>You can see the HTTP message above, it includes a websocket key that was created randomly, you need to respond correctly, AKA, handshake. So the point is, how to respond?</p>
<h4 id="1-HandShake"><a href="#1-HandShake" class="headerlink" title="1. HandShake"></a>1. HandShake</h4><p>Here is the process.</p>
<ol>
<li><p><strong>First, you need a magic key. Yeah, it was specified by the WebSocket protocol.</strong></p>
</li>
<li><p><strong>Then you need to combine it with the WebSocket key sent from the clients.</strong></p>
</li>
<li><p><strong>Calculate the HASH code of the combined string.</strong></p>
</li>
<li><p><strong>Encode the HASH code with base64.</strong></p>
</li>
<li><p><strong>Respond with an HTTP request.</strong></p>
</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 执行 WebSocket 握手</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">perform_handshake</span><span class="params">(<span class="type">int</span> sock, <span class="type">const</span> <span class="type">char</span> *req)</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *magic = <span class="string">&quot;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&quot;</span>;</span><br><span class="line">    <span class="type">char</span> response[BUF_SIZE];</span><br><span class="line">    <span class="type">char</span> key[<span class="number">256</span>];</span><br><span class="line">    <span class="type">char</span> *key_start = <span class="built_in">strstr</span>(req, <span class="string">&quot;Sec-WebSocket-Key: &quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (key_start) &#123;</span><br><span class="line">        key_start += <span class="built_in">strlen</span>(<span class="string">&quot;Sec-WebSocket-Key: &quot;</span>);</span><br><span class="line">        <span class="type">char</span> *key_end = <span class="built_in">strstr</span>(key_start, <span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (key_end) &#123;</span><br><span class="line">            <span class="built_in">strncpy</span>(key, key_start, key_end - key_start);</span><br><span class="line">            key[key_end - key_start] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 拼接客户端密钥和魔法字符串</span></span><br><span class="line">            <span class="type">char</span> accept_key[<span class="number">512</span>];</span><br><span class="line">            <span class="built_in">snprintf</span>(accept_key, <span class="keyword">sizeof</span>(accept_key), <span class="string">&quot;%s%s&quot;</span>, key, magic);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;拼接完成的str为:%s \n&quot;</span>,accept_key);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 计算 SHA1 哈希</span></span><br><span class="line">            <span class="type">unsigned</span> <span class="type">char</span> hash[SHA_DIGEST_LENGTH];</span><br><span class="line">            SHA1((<span class="type">unsigned</span> <span class="type">char</span> *)accept_key, <span class="built_in">strlen</span>(accept_key), hash);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Base64 编码</span></span><br><span class="line">            <span class="type">char</span> *encoded_hash = base64_encode(hash, <span class="keyword">sizeof</span>(hash));</span><br><span class="line"></span><br><span class="line">            <span class="built_in">snprintf</span>(response, <span class="keyword">sizeof</span>(response),</span><br><span class="line">                     <span class="string">&quot;HTTP/1.1 101 Switching Protocols\r\n&quot;</span></span><br><span class="line">                     <span class="string">&quot;Upgrade: websocket\r\n&quot;</span></span><br><span class="line">                     <span class="string">&quot;Connection: Upgrade\r\n&quot;</span></span><br><span class="line">                     <span class="string">&quot;Sec-WebSocket-Accept: %s\r\n\r\n&quot;</span>,</span><br><span class="line">                     encoded_hash);</span><br><span class="line"></span><br><span class="line">            write(sock, response, <span class="built_in">strlen</span>(response));  <span class="comment">// 发送握手响应</span></span><br><span class="line">            <span class="built_in">free</span>(encoded_hash);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Base64 编码函数</span></span><br><span class="line"><span class="type">char</span> *<span class="title function_">base64_encode</span><span class="params">(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *input, <span class="type">int</span> length)</span> &#123;</span><br><span class="line">    BIO *bmem, *b64;</span><br><span class="line">    BUF_MEM *bptr;</span><br><span class="line"></span><br><span class="line">    b64 = BIO_new(BIO_f_base64());</span><br><span class="line">    bmem = BIO_new(BIO_s_mem());</span><br><span class="line">    b64 = BIO_push(b64, bmem);</span><br><span class="line"></span><br><span class="line">    BIO_write(b64, input, length);</span><br><span class="line">    BIO_flush(b64);</span><br><span class="line">    BIO_get_mem_ptr(b64, &amp;bptr);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *buff = (<span class="type">char</span> *)<span class="built_in">malloc</span>(bptr-&gt;length);</span><br><span class="line">    <span class="built_in">memcpy</span>(buff, bptr-&gt;data, bptr-&gt;length - <span class="number">1</span>);</span><br><span class="line">    buff[bptr-&gt;length - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    BIO_free_all(b64);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> buff;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-Multiple-threads-server"><a href="#2-Multiple-threads-server" class="headerlink" title="2. Multiple threads server"></a>2. Multiple threads server</h4><p>Now let’s see how to get a simple multiple threads server.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/sha.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/evp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/bio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/buffer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iconv.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUF_SIZE 2048</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_CLNT 256</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SMALL_BUF 20</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">handle_clnt</span><span class="params">(<span class="type">void</span> *arg)</span>;  <span class="comment">// 处理客户端连接的线程函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">error_handling</span><span class="params">(<span class="type">char</span> *message)</span>;  <span class="comment">// 错误处理函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">send_message</span><span class="params">(<span class="type">char</span> *msg, <span class="type">int</span> len, <span class="type">int</span> sock)</span>;  <span class="comment">// 发送消息给所有客户端</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">perform_handshake</span><span class="params">(<span class="type">int</span> sock, <span class="type">const</span> <span class="type">char</span> *req)</span>;  <span class="comment">// 执行 WebSocket 握手</span></span><br><span class="line"><span class="type">char</span> *<span class="title function_">base64_encode</span><span class="params">(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *input, <span class="type">int</span> length)</span>;  <span class="comment">// Base64 编码函数</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">encode_frame</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *msg, <span class="type">int</span> msg_len, <span class="type">char</span> *encoded_msg, <span class="type">int</span> encoded_msg_len)</span>;  <span class="comment">// 编码 WebSocket 帧</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">decode_frame</span><span class="params">(<span class="type">char</span> *encoded_msg, <span class="type">int</span> encoded_msg_len, <span class="type">char</span> *msg, <span class="type">int</span> msg_len)</span>;  <span class="comment">// 解码 WebSocket 帧</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">read_full_frame</span><span class="params">(<span class="type">int</span> sock, <span class="type">char</span> *buffer, <span class="type">int</span> buffer_size)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">convert_encoding</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *from_encoding, <span class="type">const</span> <span class="type">char</span> *to_encoding, <span class="type">char</span> *input, <span class="type">size_t</span> input_size, <span class="type">char</span> *output, <span class="type">size_t</span> output_size)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> clnt_cnt = <span class="number">0</span>;  <span class="comment">// 当前连接的客户端数量</span></span><br><span class="line"><span class="type">int</span> clnt_socks[MAX_CLNT];  <span class="comment">// 客户端套接字数组</span></span><br><span class="line"><span class="type">pthread_mutex_t</span> mutx;  <span class="comment">// 互斥锁</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 编译命令: gcc -g server.c -o cser -lssl -lcrypto -lpthread -liconv</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="type">int</span> serv_sock, clnt_sock;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serv_adr</span>, <span class="title">clnt_adr</span>;</span></span><br><span class="line">    <span class="type">socklen_t</span> clnt_adr_sz;</span><br><span class="line"></span><br><span class="line">    <span class="type">pthread_t</span> t_id;</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_init(&amp;mutx, <span class="literal">NULL</span>);  <span class="comment">// 初始化互斥锁</span></span><br><span class="line"></span><br><span class="line">    serv_sock = socket(PF_INET, SOCK_STREAM, <span class="number">0</span>);  <span class="comment">// 创建服务器套接字</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">memset</span>(&amp;serv_adr, <span class="number">0</span>, <span class="keyword">sizeof</span>(serv_adr));</span><br><span class="line">    serv_adr.sin_family = AF_INET;</span><br><span class="line">    serv_adr.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line">    serv_adr.sin_port = htons(<span class="number">7777</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bind(serv_sock, (<span class="keyword">struct</span> sockaddr*)&amp;serv_adr, <span class="keyword">sizeof</span>(serv_adr)) == <span class="number">-1</span>)</span><br><span class="line">        error_handling(<span class="string">&quot;bind error&quot;</span>);  <span class="comment">// 绑定地址和端口</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (listen(serv_sock, <span class="number">5</span>) == <span class="number">-1</span>)</span><br><span class="line">        error_handling(<span class="string">&quot;listen error&quot;</span>);  <span class="comment">// 监听端口</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        clnt_adr_sz = <span class="keyword">sizeof</span>(clnt_adr);</span><br><span class="line">        clnt_sock = accept(serv_sock, (<span class="keyword">struct</span> sockaddr *)&amp;clnt_adr, &amp;clnt_adr_sz);  <span class="comment">// 接受客户端连接</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将套接字添加到客户端套接字数组中</span></span><br><span class="line">        pthread_mutex_lock(&amp;mutx);</span><br><span class="line">        clnt_socks[clnt_cnt++] = clnt_sock;</span><br><span class="line">        pthread_mutex_unlock(&amp;mutx);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建线程处理客户端连接</span></span><br><span class="line">        pthread_create(&amp;t_id, <span class="literal">NULL</span>, handle_clnt, (<span class="type">void</span> *)&amp;clnt_sock);</span><br><span class="line">        pthread_detach(t_id);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;connected client: %d \n&quot;</span>, clnt_sock);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    close(serv_sock);  <span class="comment">// 关闭服务器套接字</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>It’s very simple so I won’t explain it anymore, but a point we need to notice is that I didn’t use a thread pool to manage these threads, it’s not good, I will update it in the future.</p>
<h4 id="3-Handle-the-clients"><a href="#3-Handle-the-clients" class="headerlink" title="3. Handle the clients"></a>3. Handle the clients</h4><p>The most important thing here is that you need to encode and decode the websocket frames yourself, unlike HTTP frames. I will provide the functions below.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *<span class="title function_">handle_clnt</span><span class="params">(<span class="type">void</span> *arg)</span> &#123;</span><br><span class="line">    <span class="type">int</span> sock = *((<span class="type">int</span> *)arg);</span><br><span class="line">    <span class="type">int</span> str_len = <span class="number">0</span>, i;</span><br><span class="line">    <span class="type">int</span> zero_cnt=<span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> msg[BUF_SIZE];</span><br><span class="line">    <span class="type">bool</span> handshake_done = <span class="literal">false</span>;  <span class="comment">// 标志位，标识是否已经完成握手</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ((str_len = read(sock, msg, <span class="keyword">sizeof</span>(msg) - <span class="number">1</span>), MSG_WAITALL) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(str_len==<span class="number">0</span>)</span><br><span class="line">          zero_cnt++;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          zero_cnt=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span>(zero_cnt&gt;<span class="number">5</span>)</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;msg大小为:%lu,str_len大小为:%d \n&quot;</span>, <span class="keyword">sizeof</span>(msg),str_len);</span><br><span class="line">        msg[str_len] = <span class="string">&#x27;\0&#x27;</span>;  <span class="comment">// 确保字符串以 null 结尾</span></span><br><span class="line">        <span class="keyword">if</span>(!handshake_done)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;收到的原消息为: %s\n&quot;</span>, msg);</span><br><span class="line">        <span class="keyword">if</span> (!handshake_done &amp;&amp; <span class="built_in">strstr</span>(msg, <span class="string">&quot;Upgrade: websocket&quot;</span>)) &#123;</span><br><span class="line">            <span class="comment">// 检查是否为 WebSocket 握手请求</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;开始握手\n&quot;</span>);</span><br><span class="line">            perform_handshake(sock, msg);  <span class="comment">// 执行握手</span></span><br><span class="line">            handshake_done = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 解码 WebSocket 帧</span></span><br><span class="line">            <span class="type">char</span> decoded_msg[BUF_SIZE] = &#123;<span class="number">0</span>&#125;;  <span class="comment">// 初始化并清空解码消息缓冲区</span></span><br><span class="line">            <span class="type">int</span> decoded_len = decode_frame(msg, str_len, decoded_msg, <span class="keyword">sizeof</span>(decoded_msg));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (decoded_len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;解码后的消息为: %s\n&quot;</span>, decoded_msg);</span><br><span class="line">                send_message(decoded_msg, decoded_len, sock);  <span class="comment">// 发送消息</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memset</span>(msg, <span class="number">0</span>, <span class="keyword">sizeof</span>(msg));  <span class="comment">// 清空消息缓冲区</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 客户端断开连接</span></span><br><span class="line">    pthread_mutex_lock(&amp;mutx);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; clnt_cnt; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (clnt_socks[i] == sock) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> j = i; j &lt; clnt_cnt - <span class="number">1</span>; j++)</span><br><span class="line">                clnt_socks[j] = clnt_socks[j + <span class="number">1</span>];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    clnt_cnt--;</span><br><span class="line">    pthread_mutex_unlock(&amp;mutx);</span><br><span class="line">    close(sock);  <span class="comment">// 关闭客户端套接字</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 发送消息给所有客户端，除了发送者</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">send_message</span><span class="params">(<span class="type">char</span> *msg, <span class="type">int</span> len, <span class="type">int</span> sock)</span> &#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="type">char</span> encoded_msg[BUF_SIZE];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 包装消息为JSON格式</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> encoded_len = encode_frame(msg, len, encoded_msg, <span class="keyword">sizeof</span>(encoded_msg));  <span class="comment">// 编码 WebSocket 帧</span></span><br><span class="line"></span><br><span class="line">    pthread_mutex_lock(&amp;mutx);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; clnt_cnt; i++)</span><br><span class="line">        <span class="keyword">if</span> (clnt_socks[i] != sock) &#123;</span><br><span class="line">            write(clnt_socks[i], encoded_msg, encoded_len);  <span class="comment">// 发送消息</span></span><br><span class="line">        &#125;</span><br><span class="line">    pthread_mutex_unlock(&amp;mutx);      </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 编码 WebSocket 帧</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">encode_frame</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *msg, <span class="type">int</span> msg_len, <span class="type">char</span> *encoded_msg, <span class="type">int</span> encoded_msg_len)</span> &#123;</span><br><span class="line">    <span class="type">int</span> idx = <span class="number">0</span>;</span><br><span class="line">    encoded_msg[idx++] = <span class="number">0x81</span>;  <span class="comment">// FIN + 文本帧</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (msg_len &lt;= <span class="number">125</span>) &#123;</span><br><span class="line">        encoded_msg[idx++] = msg_len;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (msg_len &lt;= <span class="number">65535</span>) &#123;</span><br><span class="line">        encoded_msg[idx++] = <span class="number">126</span>;</span><br><span class="line">        encoded_msg[idx++] = (msg_len &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">        encoded_msg[idx++] = msg_len &amp; <span class="number">0xFF</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        encoded_msg[idx++] = <span class="number">127</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">7</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            encoded_msg[idx++] = (msg_len &gt;&gt; (i * <span class="number">8</span>)) &amp; <span class="number">0xFF</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(encoded_msg + idx, msg, msg_len);</span><br><span class="line">    <span class="keyword">return</span> idx + msg_len;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解码 WebSocket 帧</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">decode_frame</span><span class="params">(<span class="type">char</span> *encoded_msg, <span class="type">int</span> encoded_msg_len, <span class="type">char</span> *msg, <span class="type">int</span> msg_len)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (encoded_msg_len &lt; <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> idx = <span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> byte = encoded_msg[idx++];</span><br><span class="line">    <span class="keyword">if</span> ((byte &amp; <span class="number">0x80</span>) != <span class="number">0x80</span>) &#123;  <span class="comment">// 检查 FIN 位，确保这是最后一帧</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    byte = encoded_msg[idx++];</span><br><span class="line">    <span class="type">int</span> payload_len = byte &amp; <span class="number">0x7F</span>;  <span class="comment">// 获取负载长度</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (payload_len == <span class="number">126</span>) &#123;  <span class="comment">// 如果负载长度是 126，那么接下来的两个字节表示实际长度</span></span><br><span class="line">        <span class="keyword">if</span> (encoded_msg_len &lt; <span class="number">4</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> high_byte = encoded_msg[idx++];</span><br><span class="line">        <span class="type">int</span> low_byte = encoded_msg[idx++];</span><br><span class="line">        payload_len = (high_byte &lt;&lt; <span class="number">8</span>) | low_byte;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (payload_len == <span class="number">127</span>) &#123;  <span class="comment">// 如果负载长度是 127，那么接下来的八个字节表示实际长度</span></span><br><span class="line">        <span class="keyword">if</span> (encoded_msg_len &lt; <span class="number">10</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        payload_len = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">            payload_len = (payload_len &lt;&lt; <span class="number">8</span>) | encoded_msg[idx++];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (encoded_msg_len &lt; idx + payload_len) &#123;  <span class="comment">// 检查数据长度是否匹配</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> masked = (byte &amp; <span class="number">0x80</span>) != <span class="number">0</span>;  <span class="comment">// 检查 MASK 位</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> masking_key[<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (masked) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">            masking_key[i] = encoded_msg[idx++];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; payload_len; i++) &#123;</span><br><span class="line">        msg[i] = encoded_msg[idx + i] ^ (masked ? masking_key[i % <span class="number">4</span>] : <span class="number">0</span>);  <span class="comment">// 解码负载数据</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    msg[payload_len] = <span class="string">&#x27;\0&#x27;</span>;  <span class="comment">// 确保消息以空字符结尾</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;解码后的消息: %s\n&quot;</span>, msg);</span><br><span class="line">    <span class="keyword">return</span> payload_len;  <span class="comment">// 返回负载长度</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Remember to check the mask bit, if it was 1, then you also need to encode the frame with the mask code.</p>
<h3 id="3-Signaling"><a href="#3-Signaling" class="headerlink" title="3. Signaling"></a>3. Signaling</h3><p>To be continued.</p>
<h2 id="3-Develop-Tools-and-plugins"><a href="#3-Develop-Tools-and-plugins" class="headerlink" title="3. Develop Tools and plugins"></a>3. Develop Tools and plugins</h2><h3 id="1-Vscode"><a href="#1-Vscode" class="headerlink" title="1. Vscode"></a>1. Vscode</h3><h4 id="Plugins"><a href="#Plugins" class="headerlink" title="Plugins:"></a>Plugins:</h4><h5 id="1-MySQL"><a href="#1-MySQL" class="headerlink" title="1. MySQL"></a>1. MySQL</h5><p><img data-src="https://raw.githubusercontent.com/Hexlove2/images1/main/images/Screenshot%202024-06-30%20at%2015.07.12.png" alt="Screenshot 2024-06-30 at 15.07.12"></p>
<h5 id="2-Vue"><a href="#2-Vue" class="headerlink" title="2. Vue"></a>2. Vue</h5><p><img data-src="https://raw.githubusercontent.com/Hexlove2/images1/main/images/Screenshot%202024-07-09%20at%205.07.30%E2%80%AFPM.png" alt="Screenshot 2024-07-09 at 5.07.30 PM"></p>
<h3 id="2-mysql"><a href="#2-mysql" class="headerlink" title="2. mysql"></a>2. mysql</h3><p>Using Mysql 8.0.37</p>
<img data-src="https://raw.githubusercontent.com/Hexlove2/images1/main/images/Screenshot%202024-06-30%20at%2015.04.48.png" alt="Screenshot 2024-06-30 at 15.04.48" style="zoom: 33%;" />

<h2 id="4-Results-Demonstration"><a href="#4-Results-Demonstration" class="headerlink" title="4.Results Demonstration"></a>4.Results Demonstration</h2><p><img data-src="https://raw.githubusercontent.com/Hexlove2/images1/main/images/Screenshot%202024-07-09%20at%205.37.47%E2%80%AFPM.png" alt="Screenshot 2024-07-09 at 5.37.47 PM"></p>
<p><img data-src="https://raw.githubusercontent.com/Hexlove2/images1/main/images/Screenshot%202024-07-09%20at%205.38.22%E2%80%AFPM.png" alt="Screenshot 2024-07-09 at 5.38.22 PM"></p>
<p><img data-src="https://raw.githubusercontent.com/Hexlove2/images1/main/images/Screenshot%202024-07-09%20at%205.40.58%E2%80%AFPM.png" alt="Screenshot 2024-07-09 at 5.39.14 PM"></p>

  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">Edited on</span>
    <time title="Modified: 2024-07-09 18:41:31" itemprop="dateModified" datetime="2024-07-09T18:41:31+09:00">2024-07-09</time>
  </span>
</div>

      
<div class="reward">
  <checkbox><i class="ic i-heartbeat"></i> Donate</checkbox>
  <p>Give me a cup of [coffee]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/wechatpay.png" alt="Sunday WeChat Pay">
        <p>WeChat Pay</p>
      </div>
      
      <div>
        <img data-src="/images/alipay.png" alt="Sunday Alipay">
        <p>Alipay</p>
      </div>
      
      <div>
        <img data-src="/images/paypal.png" alt="Sunday PayPal">
        <p>PayPal</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>Post author:  </strong>Sunday <i class="ic i-at"><em>@</em></i>Hex
  </li>
  <li class="link">
    <strong>Post link: </strong>
    <a href="http://hexlove2.github.io/2024/07/01/Projects/ChatWeb/" title="ChatWeb Project">http://hexlove2.github.io/2024/07/01/Projects/ChatWeb/</a>
  </li>
  <li class="license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/2024/02/29/Notes/Socket%20learning/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;Hexlove2&#x2F;images1&#x2F;main&#x2F;images2&#x2F;18.jpg" title="TCP&#x2F;IP Socket Coding">
  <span class="type">Previous Post</span>
  <span class="category"><i class="ic i-flag"></i> Notes</span>
  <h3>TCP/IP Socket Coding</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/2024/07/07/Notes/%E9%9D%A2%E8%AF%95%E9%A2%98/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;Hexlove2&#x2F;images1&#x2F;main&#x2F;images2&#x2F;13.jpg" title="Interview Questions">
  <span class="type">Next Post</span>
  <span class="category"><i class="ic i-flag"></i> Notes</span>
  <h3>Interview Questions</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="Contents">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ChatWeb-project-notes"><span class="toc-number">1.</span> <span class="toc-text">ChatWeb project notes</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Abstract"><span class="toc-number">1.1.</span> <span class="toc-text">Abstract:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Front-End"><span class="toc-number">1.2.</span> <span class="toc-text">1. Front-End</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Vue"><span class="toc-number">1.2.1.</span> <span class="toc-text">1. Vue</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-Set-your-page"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">1.Set your page</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-Coding-about-the-home-page"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">2. Coding about the home page.</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-Coding-about-the-chat-room"><span class="toc-number">1.2.1.3.</span> <span class="toc-text">3. Coding about the chat room</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Webrtc"><span class="toc-number">1.2.2.</span> <span class="toc-text">2. Webrtc</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Back-End"><span class="toc-number">1.3.</span> <span class="toc-text">2. Back-End</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-HTTP-Server"><span class="toc-number">1.3.1.</span> <span class="toc-text">1. HTTP Server</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-Preprocessor"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">1. Preprocessor</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-Usage-of-MySql"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">2. Usage of MySql</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-Data-Match-x2F-Insert"><span class="toc-number">1.3.1.3.</span> <span class="toc-text">3. Data Match&#x2F;Insert</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Chat-Server"><span class="toc-number">1.3.2.</span> <span class="toc-text">2. Chat Server</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-HandShake"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">1. HandShake</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-Multiple-threads-server"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">2. Multiple threads server</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-Handle-the-clients"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">3. Handle the clients</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Signaling"><span class="toc-number">1.3.3.</span> <span class="toc-text">3. Signaling</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Develop-Tools-and-plugins"><span class="toc-number">1.4.</span> <span class="toc-text">3. Develop Tools and plugins</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Vscode"><span class="toc-number">1.4.1.</span> <span class="toc-text">1. Vscode</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Plugins"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">Plugins:</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-MySQL"><span class="toc-number">1.4.1.1.1.</span> <span class="toc-text">1. MySQL</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-Vue"><span class="toc-number">1.4.1.1.2.</span> <span class="toc-text">2. Vue</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-mysql"><span class="toc-number">1.4.2.</span> <span class="toc-text">2. mysql</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Results-Demonstration"><span class="toc-number">1.5.</span> <span class="toc-text">4.Results Demonstration</span></a></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="Related">
        <ul>
          <li class="active"><a href="/2024/07/01/Projects/ChatWeb/" rel="bookmark" title="ChatWeb Project">ChatWeb Project</a></li>
        </ul>
      </div>
      <div class="overview panel" data-title="Overview">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="Sunday"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">Sunday</p>
  <div class="description" itemprop="description">Looking for freedom of mind</div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">14</span>
        <span class="name">posts</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">6</span>
        <span class="name">categories</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">9</span>
        <span class="name">tags</span>
      </a>
    </div>
</nav>

<div class="social">
      <span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL0hleGxvdmUy" title="https:&#x2F;&#x2F;github.com&#x2F;Hexlove2"><i class="ic i-github"></i></span>
      <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTMxMzY0NTk5Ng==" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;313645996"><i class="ic i-cloud-music"></i></span>
      <a href="/hexlove@163.com" title="hexlove@163.com" class="item email"><i class="ic i-envelope"></i></a>
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>Home</a>
  </li>

    
  <li class="item">
    <a href="/about/" rel="section"><i class="ic i-user"></i>About</a>
  </li>

    
  <li class="item">
    <a href="/categories/" rel="section"><i class="ic i-th"></i>Categories</a>
  </li>

    
  <li class="item">
    <a href="/friends/" rel="section"><i class="ic i-heart"></i>Friends</a>
  </li>

        
  <li class="item dropdown">
      <a href="javascript:void(0);"><i class="ic i-moon"></i>Art</a>
    <ul class="submenu">

        
  <li class="item">
    <a href="/paint/" rel="section"><i class="ic i-sun"></i>Paint</a>
  </li>

  </ul>
        
  <li class="item dropdown">
      <a href="javascript:void(0);"><i class="ic i-sakura"></i>Demo</a>
    <ul class="submenu">

        
  <li class="item">
    <a href="/HTML/index.html" rel="section"><i class="ic i-flag"></i>Score</a>
  </li>

  </ul>

</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/2024/02/29/Notes/Socket%20learning/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/2024/07/07/Notes/%E9%9D%A2%E8%AF%95%E9%A2%98/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>Random Posts</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Coding/" title="In Coding">Coding</a>
</div>

    <span><a href="/2024/07/22/Coding/PjSip_Usage/" title="Usage of PjSip">Usage of PjSip</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Journey/" title="In Journey">Journey</a>
</div>

    <span><a href="/2022/11/19/Journey/My%20diary/" title="First Diary">First Diary</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Coding/" title="In Coding">Coding</a>
</div>

    <span><a href="/2022/12/05/Coding/Unity+Git/" title="Unity+Git">Unity+Git</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2022/06/09/hello-world/" title="Hello World">Hello World</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Games/" title="In Games">Games</a>
</div>

    <span><a href="/2024/07/11/Games/Elden%20ring/" title="Elden Ring">Elden Ring</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Coding/" title="In Coding">Coding</a>
</div>

    <span><a href="/2022/08/31/Coding/Comparison%20Between%20Hue%20and%20red%20subtract%20blue%20channel%20detect/" title="缺陷检测方法对比">缺陷检测方法对比</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Projects/" title="In Projects">Projects</a>
</div>

    <span><a href="/2024/07/01/Projects/ChatWeb/" title="ChatWeb Project">ChatWeb Project</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Notes/" title="In Notes">Notes</a>
</div>

    <span><a href="/2023/01/09/Notes/Csharp%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="C#初级笔记">C#初级笔记</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Journey/" title="In Journey">Journey</a>
</div>

    <span><a href="/2022/10/29/Journey/hexo/" title="关于Hexo s显示正常但Hexo d没有更新内容的问题">关于Hexo s显示正常但Hexo d没有更新内容的问题</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Coding/" title="In Coding">Coding</a>
</div>

    <span><a href="/2022/12/09/Coding/Fox%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/" title="Fox项目笔记">Fox项目笔记</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>Recent Comments</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Sunday @ Hex</span>
  </div>
  <div class="powered-by">
    Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2024/07/01/Projects/ChatWeb/',
    favicon: {
      show: "（●´3｀●）Goooood",
      hide: "(´Д｀)Booooom"
    },
    search : {
      placeholder: "Search for Posts",
      empty: "We didn't find any results for the search: ${query}",
      stats: "${hits} results found in ${time} ms"
    },
    valine: true,fancybox: true,
    copyright: 'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
